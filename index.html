<!DOCTYPE html>
<html lang="ja">
<head>
Â  <meta charset="UTF-8">
Â  <title>ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ¯ãƒ¼ãƒ‰ã‚¬ãƒãƒ£</title>
Â  <meta name="viewport" content="width=device-width, initial-scale=1">
Â  <style>
Â  Â  /* --- Base Layout --------------------------------------------------- */
Â  Â  html,body{height:100%;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans JP",sans-serif;background:#f0f0f0;}
Â  Â  body{display:flex;justify-content:center;align-items:stretch;}
Â  Â  .container{display:flex;flex-direction:column;max-width:600px;width:100%;padding:20px;box-sizing:border-box;}
Â  Â  h1{margin:0 0 12px;text-align:center;font-size:1.6em;}

Â  Â  /* --- Lucky Banner -------------------------------------------------- */
Â  Â  #luckyBanner{background:#ff9800;color:#fff;padding:4px 8px;border-radius:6px;font-weight:bold;margin-bottom:8px;display:flex;gap:6px;align-items:center;}
Â  Â  #luckyBanner span.timer{font-variant-numeric:tabular-nums;}

Â  Â  /* --- Game Area ----------------------------------------------------- */
Â  Â  #gameArea{flex:1 0 auto;display:flex;flex-direction:column;align-items:center;}
Â  Â  #roulette{margin:12px auto;border-radius:50%;border:8px solid #ccc;width:150px;height:150px;display:flex;align-items:center;justify-content:center;font-size:2em;background:#fff;transition:transform 1s cubic-bezier(.33,1,.68,1);}Â  Â Â 
Â  Â  button{padding:10px;margin:4px 0;width:100%;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer;font-size:1em;}
Â  Â  button:hover{background:#f7f7f7;}
Â  Â  .action-buttons{width:100%;max-width:400px;display:flex;gap:4px;flex-wrap:wrap;justify-content:center;}
Â  Â  .action-buttons button{flex:1 1 120px;}
Â  Â  #result{font-size:1.3em;text-align:center;margin-top:12px;white-space:pre-line;min-height:2.6em;}
Â  Â  .hit{animation:bounce .6s ease;}
Â  Â  @keyframes bounce{0%{transform:scale(0);}60%{transform:scale(1.25);}100%{transform:scale(1);}}

Â  Â  /* --- History & Input ---------------------------------------------- */
Â  Â  #rewardHistory{background:#fff;border-radius:8px;padding:10px;margin:18px 0;min-height:44px;}
Â  Â  .history-title{font-weight:bold;}
Â  Â  .history-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
Â  Â  .history-item{background:#ffeef0;border:1px solid #e91e63;border-radius:5px;padding:3px 8px;display:flex;align-items:center;}
Â  Â  .history-remove{margin-left:4px;color:#e91e63;cursor:pointer;font-size:.9em;background:none;border:none;}
Â  Â  #clearHistoryBtn{margin-left:8px;background:#e91e63;color:#fff;border:none;border-radius:4px;padding:4px 12px;}

Â  Â  /* --- Rewards Input (bottom) --------------------------------------- */
Â  Â  #rewardsSection{margin-top:auto;}
Â  Â  #rewardsInput{width:100%;height:110px;padding:8px;margin-top:10px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}
Â  Â  #rewardsSection p{margin:6px 0;}

Â  Â  /* --- Mobile Tweaks ------------------------------------------------- */
Â  Â  @media(max-width:400px){
Â  Â  Â  h1{font-size:1.3em;}
Â  Â  Â  #roulette{width:110px;height:110px;border-width:6px;font-size:1.6em;}
Â  Â  Â  .action-buttons button{flex:1 1 100%;margin:3px 0;}
Â  Â  Â  #result{font-size:1.1em;}
Â  Â  }
Â  </style>
</head>
<body>
Â  <div class="container">
Â  Â  <div id="gameArea">
Â  Â  Â  Â  Â  Â  <h1>ğŸ° ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ¯ãƒ¼ãƒ‰ã‚¬ãƒãƒ£ ğŸ°</h1>
Â  Â  Â  <div id="roulette">ğŸ¯</div>
Â  Â  Â  <div class="action-buttons">
Â  Â  Â  Â  <button onclick="drawSingle()">ã‚¬ãƒãƒ£ã‚’å›ã™ï¼</button>
Â  Â  Â  Â  <button onclick="drawFive()">5é€£ã‚¬ãƒãƒ£ï¼</button>
Â  Â  Â  Â  <button onclick="drawTen()">10é€£ã‚¬ãƒãƒ£ï¼</button>
Â  Â  Â  </div>
Â  Â  Â  <div id="result"></div>

Â  Â  Â  <div id="rewardHistory">
Â  Â  Â  Â  <span class="history-title">ğŸ ç²å¾—ã—ãŸãƒªãƒ¯ãƒ¼ãƒ‰ä¸€è¦§</span>
Â  Â  Â  Â  <button id="clearHistoryBtn" onclick="clearHistory()">å…¨å‰Šé™¤</button>
Â  Â  Â  Â  <div id="historyList" class="history-list"></div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <section id="rewardsSection">
Â  Â  Â  <p>ãƒªãƒ¯ãƒ¼ãƒ‰ã‚’ <code>ãƒªãƒ¯ãƒ¼ãƒ‰å,ç¢ºç‡(%)</code> ã®å½¢å¼ã§æ”¹è¡Œã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
Â  Â  Â  <textarea id="rewardsInput" oninput="saveRewardsInput()"></textarea>
Â  Â  </section>
Â  </div>

<script>
Â  /****************** è¨­å®šå€¤ ******************/
Â  const LUCKY_DURATION_MINUTES = 60;Â  Â  Â  Â  Â  // ãƒœãƒ¼ãƒŠã‚¹ã‚¿ã‚¤ãƒ ç¶™ç¶šæ™‚é–“ï¼ˆåˆ†ï¼‰
Â  const LUCKY_LEVELS = [1.5, 3, 5, 7.5, 10];Â  // 5 æ®µéšå€ç‡ (ãƒ¦ãƒ¼ã‚¶ãƒ¼éè¡¨ç¤º)
Â  const BONUS_PROBABILITY = 0.3;Â  Â  Â  Â  Â  Â  Â  // çªå…¥ç¢ºç‡ 30 %
Â  const MISS_THRESHOLD = 15;Â  Â  Â  Â  Â  Â  Â  Â  Â  // ãƒã‚ºãƒ¬é€£ç¶šå›æ•°

Â  /****************** ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é–¢é€£ *********/
Â  let rewardHistory = JSON.parse(localStorage.getItem('rewardHistory')||'[]');
Â  let consecutiveMisses = parseInt(localStorage.getItem('consecutiveMisses')||'0',10);

Â  function saveHistory(){localStorage.setItem('rewardHistory',JSON.stringify(rewardHistory));}
Â  function saveConsecutive(){localStorage.setItem('consecutiveMisses',consecutiveMisses);}Â Â 
Â  function saveRewardsInput(){localStorage.setItem('rewardsInput',document.getElementById('rewardsInput').value);}Â Â 
Â  function loadRewardsInput(){const saved=localStorage.getItem('rewardsInput');document.getElementById('rewardsInput').value=saved!==null?saved:'ãƒãƒƒãƒˆã‚µãƒ¼ãƒ•ã‚£ãƒ³10åˆ†,10\nå‹•ç”»è¦–è´30åˆ†,5\nãŠè“å­ä¼‘æ†©,3\næ˜¼å¯15åˆ†,1';}

Â  /****************** UIæç”» *******************/
Â  function renderHistory(){const list=document.getElementById('historyList');list.innerHTML='';rewardHistory.forEach((item,i)=>{const span=document.createElement('span');span.className='history-item';let label='';if(item.rank==='å¤§å½“ãŸã‚Š')label='â˜…å¤§å½“ãŸã‚Š! ';else if(item.rank==='å½“ãŸã‚Š')label='å½“ãŸã‚Š! ';span.innerHTML=`${label}${item.name} <button class="history-remove" onclick="removeHistory(${i})">âœ•</button>`;list.appendChild(span);});}

Â  function removeHistory(i){rewardHistory.splice(i,1);renderHistory();saveHistory();}
Â  function clearHistory(){rewardHistory=[];renderHistory();saveHistory();}
Â  function clearResult(){document.getElementById('result').textContent='';}

Â  /****************** ãƒœãƒ¼ãƒŠã‚¹ã‚¿ã‚¤ãƒ åˆ¶å¾¡ *******/
Â  function isLuckyTime(){return Date.now() < parseInt(localStorage.getItem('luckyUntil')||'0',10);}Â Â 
Â  function getLuckyBoost(){return parseFloat(localStorage.getItem('luckyBoost')||'1');}
Â  function startLuckyTime(){// å€ç‡ã¯ç§˜åŒ¿
Â  Â  const boost = LUCKY_LEVELS[Math.floor(Math.random()*LUCKY_LEVELS.length)];
Â  Â  localStorage.setItem('luckyBoost',boost);
Â  Â  localStorage.setItem('luckyUntil',Date.now()+LUCKY_DURATION_MINUTES*60*1000);
Â  Â  showLuckyBanner();
Â  }
Â  function attemptBonusActivation(){if(isLuckyTime())return; if(Math.random()<BONUS_PROBABILITY){startLuckyTime();}}

Â  function applyLuckyBoost(rewards){if(!isLuckyTime())return rewards;const boost=getLuckyBoost();const boosted=rewards.map(r=>({...r}));let total=0;boosted.forEach(r=>{if(r.name!=='ãƒã‚ºãƒ¬')r.chance*=boost;total+=r.chance;});boosted.forEach(r=>{r.chance=100*r.chance/total;});return boosted;}

Â  /****************** Lucky Banner ************/
Â  function showLuckyBanner(){
Â  Â  const area=document.getElementById('gameArea');
Â  Â  let banner=document.getElementById('luckyBanner');
Â  Â  if(!isLuckyTime()){if(banner)banner.remove();return;}
Â  Â  if(!banner){
Â  Â  Â  banner=document.createElement('div');
Â  Â  Â  banner.id='luckyBanner';
Â  Â  Â  banner.innerHTML='â­ BONUS TIME! å½“é¸ç‡UPä¸­ <span class="timer"></span>';
Â  Â  Â  area.prepend(banner);
Â  Â  }
Â  Â  updateBanner();
Â  Â  if(!banner._timer){banner._timer=setInterval(updateBanner,1000);}Â Â 
Â  Â  function updateBanner(){
Â  Â  Â  const remain=Math.max(0, parseInt(localStorage.getItem('luckyUntil')) - Date.now());
Â  Â  Â  if(remain<=0){clearInterval(banner._timer);banner._timer=null;banner.remove();return;}
Â  Â  Â  const mins=Math.floor(remain/60000).toString().padStart(2,'0');
Â  Â  Â  const secs=Math.floor((remain%60000)/1000).toString().padStart(2,'0');
Â  Â  Â  banner.querySelector('.timer').textContent=`(${mins}:${secs})`;
Â  Â  }
Â  }

Â  /****************** ãƒªãƒ¯ãƒ¼ãƒ‰å‡¦ç† *************/
Â  function parseRewards(){return document.getElementById('rewardsInput').value.trim().split(/\n+/).map(l=>{const[name,c]=l.split(',');return{name:(name||'').trim(),chance:parseFloat((c||'').trim())};}).filter(r=>r.name&&!isNaN(r.chance)&&r.chance>0);}Â Â 

Â  function pickReward(rewards){
    // ç¢ºç‡ã®åˆè¨ˆã‚’è¨ˆç®—
    const totalChance = rewards.reduce((sum, r) => sum + r.chance, 0);
    // 100%ã«æº€ãŸãªã„åˆ†ã‚’ãƒã‚ºãƒ¬ã®ç¢ºç‡ã¨ã™ã‚‹
    const missChance = Math.max(0, 100 - totalChance);
    const rand = Math.random() * 100;
    
    let cumulative = 0;
    for (const reward of rewards) {
        cumulative += reward.chance;
        if (rand < cumulative) {
            return reward.name;
        }
    }
    return 'ãƒã‚ºãƒ¬';
  }

  function getRewardRank(name, rewards) {
    if (name === 'ãƒã‚ºãƒ¬') return 'ãƒã‚ºãƒ¬';
    const reward = rewards.find(r => r.name === name);
    if (!reward) return '';

    const nonMissRewards = rewards.filter(r => r.name !== 'ãƒã‚ºãƒ¬');
    if (nonMissRewards.length === 0) return '';
    
    const sortedChances = nonMissRewards.map(r => r.chance).sort((a, b) => a - b);
    const greatThreshold = sortedChances[Math.floor(sortedChances.length * 0.1)]; // ä¸Šä½10%ã‚’å¤§å½“ãŸã‚Š
    const goodThreshold = sortedChances[Math.floor(sortedChances.length * 0.3)]; // ä¸Šä½30%ã‚’å½“ãŸã‚Š

    if (reward.chance <= greatThreshold) return 'å¤§å½“ãŸã‚Š';
    if (reward.chance <= goodThreshold) return 'å½“ãŸã‚Š';
    return '';
  }

  /**
   * ã‚¬ãƒãƒ£å‡¦ç†ã®ä¸­å¿ƒã¨ãªã‚‹é–¢æ•°
   * @param {number} count - ã‚¬ãƒãƒ£ã‚’å¼•ãå›æ•°
   */
  function drawMultiple(count) {
    const roulette = document.getElementById('roulette');
    const resultDiv = document.getElementById('result');
    
    let baseRewards = parseRewards();
    if (baseRewards.length === 0) {
      resultDiv.textContent = 'ãƒªãƒ¯ãƒ¼ãƒ‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
      return;
    }

    // ãƒœãƒ¼ãƒŠã‚¹ã‚¿ã‚¤ãƒ ã®ç¢ºç‡è£œæ­£ã‚’é©ç”¨
    const rewards = applyLuckyBoost(baseRewards);
    
    // ã‚¬ãƒãƒ£ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
    roulette.style.transform = `rotate(${360 + Math.random() * 360}deg)`;
    resultDiv.innerHTML = ''; // å‰å›ã®çµæœã‚’ã‚¯ãƒªã‚¢
    
    setTimeout(() => {
      let results = [];
      let gotHit = false;

      for (let i = 0; i < count; i++) {
        let pickedName = pickReward(rewards);

        // é€£ç¶šãƒã‚ºãƒ¬æ•‘æ¸ˆæªç½®
        if (consecutiveMisses >= MISS_THRESHOLD && pickedName === 'ãƒã‚ºãƒ¬') {
            const nonMissRewards = rewards.filter(r => r.name !== 'ãƒã‚ºãƒ¬');
            if (nonMissRewards.length > 0) {
                pickedName = nonMissRewards[Math.floor(Math.random() * nonMissRewards.length)].name;
            }
        }

        if (pickedName !== 'ãƒã‚ºãƒ¬') {
          gotHit = true;
          consecutiveMisses = 0; // å½“ãŸã£ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
          const rank = getRewardRank(pickedName, baseRewards);
          const newHistoryItem = { name: pickedName, rank: rank, date: Date.now() };
          rewardHistory.unshift(newHistoryItem); // æ–°ã—ã„é †ã«å±¥æ­´è¿½åŠ 
          results.push(`${rank ? `ã€${rank}ã€‘` : ''}${pickedName}`);
        } else {
          consecutiveMisses++;
          results.push('ãƒã‚ºãƒ¬');
        }
        attemptBonusActivation(); // æ¯å›ãƒœãƒ¼ãƒŠã‚¹çªå…¥åˆ¤å®š
      }
      
      saveConsecutive();
      saveHistory();
      renderHistory();
      
      // çµæœã®è¡¨ç¤º
      resultDiv.innerHTML = results.join('\n');
      if(gotHit) {
        resultDiv.classList.add('hit');
        setTimeout(() => resultDiv.classList.remove('hit'), 600);
      }
      
    }, 1000); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒçµ‚ã‚ã‚‹ã®ã‚’å¾…ã¤
  }

  // æ—¢å­˜ã®é–¢æ•°ã‚’ä¸Šæ›¸ãã—ã¦ã€æ–°ã—ã„ drawMultiple ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ã«ã—ã¾ã™
  function drawSingle() { drawMultiple(1); }
  function drawFive() { drawMultiple(5); }
  function drawTen() { drawMultiple(10); }


  // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«å®Ÿè¡Œã™ã‚‹å‡¦ç†
  window.onload = () => {
    loadRewardsInput();
    renderHistory();
    showLuckyBanner();
  };
</script>
</body>
</html>
