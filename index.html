<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ¯ãƒ¼ãƒ‰ã‚¬ãƒãƒ£ v1.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    /* â€”â€”â€” Global Layout â€”â€”â€” */
    html,body{height:100%;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans JP,sans-serif;background:#f0f0f0;}
    body{display:flex;justify-content:center;align-items:stretch;}
    .container{display:flex;flex-direction:column;max-width:600px;width:100%;padding:20px;box-sizing:border-box;}
    h1{margin:0 0 12px;text-align:center;font-size:1.6em;}

    /* â€”â€”â€” Lucky Banner â€”â€”â€” */
    #luckyBanner{background:#ff9800;color:#fff;padding:4px 8px;border-radius:6px;font-weight:bold;margin-bottom:8px;display:flex;gap:6px;align-items:center;}
    #luckyBanner .timer{font-variant-numeric:tabular-nums;}

    /* â€”â€”â€” Game Area â€”â€”â€” */
    #gameArea{flex:1 0 auto;display:flex;flex-direction:column;align-items:center;}
    #roulette{margin:12px auto;border-radius:50%;border:8px solid #ccc;width:150px;height:150px;display:flex;align-items:center;justify-content:center;font-size:2em;background:#fff;transition:transform 1s cubic-bezier(.33,1,.68,1);}    
    button{padding:10px;margin:4px 0;width:100%;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer;font-size:1em;}
    button:hover{background:#f7f7f7;}
    .action-buttons{width:100%;max-width:400px;display:flex;gap:4px;flex-wrap:wrap;justify-content:center;}
    .action-buttons button{flex:1 1 120px;}
    #result{font-size:1.3em;text-align:center;margin-top:12px;white-space:pre-line;min-height:2.6em;}
    .hit{animation:bounce .6s ease;}
    @keyframes bounce{0%{transform:scale(0);}60%{transform:scale(1.25);}100%{transform:scale(1);}}

    /* â€”â€”â€” History â€”â€”â€” */
    #rewardHistory{background:#fff;border-radius:8px;padding:10px;margin:18px 0;min-height:44px;}
    .history-title{font-weight:bold;}
    .history-list{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
    .history-item{background:#ffeef0;border:1px solid #e91e63;border-radius:5px;padding:3px 8px;display:flex;align-items:center;}
    .history-remove{margin-left:4px;color:#e91e63;cursor:pointer;font-size:.8em;background:none;border:none;}
    #clearHistoryBtn{margin-left:8px;background:#e91e63;color:#fff;border:none;border-radius:4px;padding:4px 12px;}

    /* â€”â€”â€” Rewards Input â€”â€”â€” */
    #rewardsSection{margin-top:auto;}
    #rewardsInput{width:100%;height:110px;padding:8px;margin-top:10px;border-radius:6px;border:1px solid #ccc;box-sizing:border-box;}

    /* â€”â€”â€” Mobile Tweaks â€”â€”â€” */
    @media(max-width:400px){
      h1{font-size:1.3em;}
      #roulette{width:110px;height:110px;border-width:6px;font-size:1.6em;}
      .action-buttons button{flex:1 1 100%;margin:3px 0;}
      #result{font-size:1.1em;}
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="gameArea">
      <!-- Lucky banner will be inserted here -->
      <h1>ğŸ° ã‚«ã‚¹ã‚¿ãƒ ãƒªãƒ¯ãƒ¼ãƒ‰ã‚¬ãƒãƒ£ ğŸ°</h1>
      <div id="roulette">ğŸ¯</div>
      <div class="action-buttons">
        <button onclick="drawSingle()">ã‚¬ãƒãƒ£ã‚’å›ã™ï¼</button>
        <button onclick="drawFive()">5é€£ã‚¬ãƒãƒ£ï¼</button>
        <button onclick="drawTen()">10é€£ã‚¬ãƒãƒ£ï¼</button>
      </div>
      <div id="result"></div>

      <div id="rewardHistory">
        <span class="history-title">ğŸ ç²å¾—ã—ãŸãƒªãƒ¯ãƒ¼ãƒ‰ä¸€è¦§</span>
        <button id="clearHistoryBtn" onclick="clearHistory()">å…¨å‰Šé™¤</button>
        <div id="historyList" class="history-list"></div>
      </div>
    </div>

    <section id="rewardsSection">
      <p>ãƒªãƒ¯ãƒ¼ãƒ‰ã‚’ <code>ãƒªãƒ¯ãƒ¼ãƒ‰å,ç¢ºç‡(%)</code> ã®å½¢å¼ã§æ”¹è¡Œã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
      <textarea id="rewardsInput" oninput="saveRewardsInput()"></textarea>
    </section>

    <footer id="version" style="text-align:center;margin-top:12px;color:#888;">v1.0</footer>
  </div>

<script>
// â€”â€”â€” CONFIG â€”â€”â€”
const LUCKY_DURATION_MIN = 60;
const LUCKY_LEVELS = [1.5,3,5,7.5,10];
const BONUS_PROB = 0.3;
const MISS_THRESHOLD = 15;

// â€”â€”â€” STATE & STORAGE â€”â€”â€”
let rewardHistory = JSON.parse(localStorage.getItem('rewardHistory')||'[]');
let consecutiveMisses = Number(localStorage.getItem('consecutiveMisses')||0);

const save = {
  history: ()=>localStorage.setItem('rewardHistory',JSON.stringify(rewardHistory)),
  misses: ()=>localStorage.setItem('consecutiveMisses',consecutiveMisses),
  input: ()=>localStorage.setItem('rewardsInput',document.getElementById('rewardsInput').value)
};

function loadInput(){
  const v = localStorage.getItem('rewardsInput');
  document.getElementById('rewardsInput').value = v ?? 'ãƒãƒƒãƒˆã‚µãƒ¼ãƒ•ã‚£ãƒ³10åˆ†,10';
}

// â€”â€”â€” UTILS â€”â€”â€”
function $(id){return document.getElementById(id);} // shorthand
function isLucky(){return Date.now() < (+localStorage.getItem('luckyUntil')||0);}  
function luckyBoost(){return +localStorage.getItem('luckyBoost')||1;}

// â€”â€”â€” LUCKY CONTROL â€”â€”â€”
function startLucky(){
  const boost = LUCKY_LEVELS[Math.random()*LUCKY_LEVELS.length|0];
  localStorage.setItem('luckyBoost',boost);
  localStorage.setItem('luckyUntil',Date.now()+LUCKY_DURATION_MIN*60000);
  showBanner();
}
function maybeStartLucky(){ if(!isLucky() && Math.random()<BONUS_PROB) startLucky(); }
function applyBoost(list){
  if(!isLucky()) return list;
  const b = luckyBoost();
  const arr = list.map(o=>({...o}));
  let total = 0;
  arr.forEach(o=>{if(o.name!=='ãƒã‚ºãƒ¬') o.chance *= b; total += o.chance;});
  arr.forEach(o=> o.chance = 100*o.chance/total);
  return arr;
}

// â€”â€”â€” BANNER â€”â€”â€”
function showBanner(){
  const area = $('gameArea');
  let ban = $('luckyBanner');
  if(!isLucky()) { if(ban) ban.remove(); return; }
  if(!ban){
    ban = document.createElement('div'); ban.id='luckyBanner';
    ban.innerHTML = 'â­ BONUS TIME! å½“é¸ç‡UPä¸­ <span class="timer"></span>';
    area.prepend(ban);
  }
  const timer = ban.querySelector('.timer');
  function tick(){
    const remain = +localStorage.getItem('luckyUntil') - Date.now();
    if(remain<=0){clearInterval(ban._id); ban.remove(); return;}
    const m = String(Math.floor(remain/60000)).padStart(2,'0');
    const s = String(Math.floor((remain%60000)/1000)).padStart(2,'0');
    timer.textContent = `(${m}:${s})`;
  }
  tick();
  if(!ban._id) ban._id = setInterval(tick,1000);
}

// â€”â€”â€” HISTORY RENDER â€”â€”â€”
function renderHistory(){
  const list = $('historyList'); list.innerHTML='';
  rewardHistory.forEach((itm,i)=>{
    const span=document.createElement('span'); span.className='history-item';
    let label=''; if(itm.rank==='å¤§å½“ãŸã‚Š') label='â˜…å¤§å½“ãŸã‚Š! '; else if(itm.rank==='å½“ãŸã‚Š') label='å½“ãŸã‚Š! ';
    span.innerHTML = `${label}${itm.name} <button class="history-remove" onclick="removeHistory(${i})">âœ•</button>`;
    list.appendChild(span);
  });
}
function removeHistory(i){ rewardHistory.splice(i,1); renderHistory(); save.history(); }
function clearHistory(){ rewardHistory=[]; renderHistory(); save.history(); }

// â€”â€”â€” CORE HELPERS â€”â€”â€”
function parseRewards(){
  return $('rewardsInput').value.trim().split(/\n+/).map(l=>{
    const [name,c] = l.split(',');
    return {name:(name||'').trim(), chance:+(c||0)};
  }).filter(r=>r.name && r.chance>0);
}
function pick(list){
  let r=Math.random()*100, cum=0;
  for(const o of list){cum += o.chance; if(r<=cum) return o.name;}
  return 'ãƒã‚ºãƒ¬';
}
function rank(name,list){ const f=list.find(o=>o.name===name); return f? (f.chance<2?'å¤§å½“ãŸã‚Š':'å½“ãŸã‚Š') : ''; }

// â€”â€”â€” ANIMATION â€”â€”â€”
function spin(ms){
  const r=$('roulette'); r.style.transition='none'; r.style.transform='rotate(0deg)'; void r.offsetWidth;
  const deg = 3600 + Math.random()*360;
  r.style.transition = `transform ${ms/1000}s cubic-bezier(.33,1,.68,1)`;
  r.style.transform = `rotate(${deg}deg)`;
}

// â€”â€”â€” DRAW LOGIC â€”â€”â€”
function draw(count,ms){
  $('result').textContent=''; save.input();
  let list=parseRewards();
  const sum=list.reduce((s,o)=>s+o.chance,0);
  if(sum>100) return alert('ç¢ºç‡åˆè¨ˆãŒ100%ã‚’è¶…ãˆã¦ã„ã¾ã™');
  list.push({name:'ãƒã‚ºãƒ¬',chance:100-sum});
  list=applyBoost(list);

  spin(ms);
  setTimeout(()=>{
    const resArr=Array.from({length:count},()=>pick(list));
    if(count===1) showSingle(resArr[0],list); else showMulti(resArr,list);

    resArr.forEach(r=>{
      if(r==='ãƒã‚ºãƒ¬') { consecutiveMisses++; if(consecutiveMisses>=MISS_THRESHOLD) maybeStartLucky(); }
      else {
        consecutiveMisses=0; rewardHistory.push({name:r,rank:rank(r,list)}); save.history(); renderHistory(); maybeStartLucky();
      }
    });
    save.misses(); showBanner();
  },ms);
}

// â€”â€”â€” RESULT UI â€”â€”â€”
function showSingle(res,list){
  const div=$('result');
  if(res==='ãƒã‚ºãƒ¬') {div.textContent='ğŸ˜¢ ãƒã‚ºãƒ¬ï¼ğŸ˜¢'; return;}
  const rnk=rank(res,list); let label='';
  if(rnk==='å¤§å½“ãŸã‚Š') label='<span style="color:#ffd700;font-weight:bold;">â˜…å¤§å½“ãŸã‚Šï¼</span><br>';
  else if(rnk==='å½“ãŸã‚Š') label='<span style="color:#2196f3;font-weight:bold;">å½“ãŸã‚Šï¼</span><br>';
  div.className='hit';
  div.innerHTML=`ğŸ‰ ${label}<span class="highlight">${res}</span>`;
  setTimeout(()=>div.className='',600);
}

function showMulti(arr,list){
  const div=$('result'); div.textContent='';
  let i=0;
  (function reveal(){
    const r=arr[i]; let line='';
    if(r==='ãƒã‚ºãƒ¬') line='ğŸ˜¢ ãƒã‚ºãƒ¬';
    else {
      const rk=rank(r,list);
      if(rk==='å¤§å½“ãŸã‚Š') line=`ğŸ‰ <span style="color:#ffd700;font-weight:bold;">â˜…å¤§å½“ãŸã‚Š!</span> <span class="highlight">${r}</span>`;
      else if(rk==='å½“ãŸã‚Š') line=`ğŸ‰ <span style="color:#2196f3;font-weight:bold;">å½“ãŸã‚Š!</span> <span class="highlight">${r}</span>`;
      else line=`ğŸ‰ <span class="highlight">${r}</span>`;
    }
    div.innerHTML += `${i+1}. ${line}
`;
    if(++i < arr.length) setTimeout(reveal,300);
  })();
}

// â€”â€”â€” BUTTON WRAPPERS (global) â€”â€”â€”
function drawSingle(){draw(1,1000);}  
function drawFive(){draw(5,2000);}  
function drawTen(){draw(10,3000);}  

// â€”â€”â€” INIT â€”â€”â€”
renderHistory();
loadInput();
showBanner();
</script>
</body>
</html>
